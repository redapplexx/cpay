rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is a member of a specific partner
    function isPartnerMember(partnerId) {
      return request.auth != null && request.auth.token.partnerId == partnerId;
    }

    // Helper function to check if a user has a specific role in a partner
    function hasPartnerRole(partnerId, role) {
      return isPartnerMember(partnerId) && request.auth.token.role == role;
    }
    
    function hasPartnerRoles(partnerId, roles) {
      return isPartnerMember(partnerId) && request.auth.token.role in roles;
    }

    // Main CPay User Data
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow read, update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN'; // Core CPay admin
      allow create: if false; // Created by backend triggers
    }

    match /users/{userId}/wallets/{currency} {
      allow read: if request.auth.uid == userId;
      allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN'; // Core CPay admin
      allow write: if false; // Only updated by trusted backend Cloud Functions
    }

    // KYC & KYB Submissions
    match /kycSubmissions/{submissionId} {
      allow create: if request.auth.uid == request.resource.data.uid;
      allow read, update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }

    match /merchants/{merchantId} {
      allow create: if request.auth != null;
      allow read, update: if get(/databases/$(database)/documents/merchants/$(merchantId)/users/$(request.auth.uid)).data.role in ['OWNER', 'APPROVER'];
      allow read, update: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }

    match /merchants/{merchantId}/users/{userId} {
      allow read: if exists(/databases/$(database)/documents/merchants/$(merchantId)/users/$(request.auth.uid));
      allow write: if get(/databases/$(database)/documents/merchants/$(merchantId)/users/$(request.auth.uid)).data.role == 'OWNER';
      allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }

    // Transaction Ledger
    match /transactions/{transactionId} {
      allow write: if false; // Immutable from client
      allow read: if request.auth.uid == resource.data.sender.uid || request.auth.uid == resource.data.receiver.uid;
      allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }

    // Partner Portal Rules
    match /partners/{partnerId} {
      // Core CPay admins can read/write partners (for onboarding partners themselves)
      allow create, read, update: if request.auth.token.role == 'ADMIN';

      // Partner users can read their own partner's main document if they belong to that partner
      allow read: if request.auth.token.partnerId == partnerId;

      // Only 'OWNER' role within the partner can update the partner's main document
      allow update: if request.auth.token.partnerId == partnerId && request.auth.token.role == 'OWNER';
    }

    match /partners/{partnerId}/users/{userId} {
      // A partner user can read users in their OWN partner's sub-collection
      allow read: if request.auth.token.partnerId == partnerId;

      // Only 'OWNER' or 'ADMIN' roles within the partner can create/update/delete partner_users
      allow write: if request.auth.token.partnerId == partnerId && request.auth.token.role in ['OWNER', 'ADMIN'];
    }

    match /partners/{partnerId}/payoutBatches/{batchId} {
        // 'OPERATOR', 'ADMIN', 'OWNER' can create/read payout batches. 'VIEWER' can only read.
        allow create: if hasPartnerRoles(partnerId, ['OPERATOR', 'ADMIN', 'OWNER']);
        allow read: if isPartnerMember(partnerId);
        
        // Batches are immutable from the client once created.
        allow update, delete: if false;
    }
    
    match /partners/{partnerId}/payoutLogs/{logId} {
        // Any member of the partner can read the payout logs for their batches.
        allow read: if isPartnerMember(partnerId);
        
        // Logs are written by backend functions only.
        allow write: if false;
    }

    match /partners/{partnerId}/webhookLogs/{logId} {
        // 'ADMIN' or 'OWNER' can view and resend webhooks.
        allow read, update: if hasPartnerRoles(partnerId, ['ADMIN', 'OWNER']);
        allow create, delete: if false;
    }
    
    match /partners/{partnerId}/auditLogs/{logId} {
        // 'ADMIN' or 'OWNER' can view the audit trail for their partner account.
        allow read: if hasPartnerRoles(partnerId, ['ADMIN', 'OWNER']);
        allow write: if false;
    }

    // Payout Batches (Global collection)
    match /payoutBatches/{batchId} {
        // Only partner users of the associated partner can read/create payout batches
        allow create: if request.auth.token.partnerId == request.resource.data.partnerId;
        allow read: if request.auth.token.partnerId == resource.data.partnerId;
        // Updates and deletes only via backend functions
        allow update, delete: if false;
    }

    // Payout Logs (Global collection)
    match /payoutLogs/{logId} {
        // Only partner users of the associated partner can read payout logs
        allow read: if request.auth.token.partnerId == resource.data.partnerId;
        allow write: if false; // Only written by backend functions
    }

    // Webhook Logs (Global collection)
    match /webhookLogs/{logId} {
        // Only partner users of the associated partner can read webhook logs
        allow read: if request.auth.token.partnerId == resource.data.partnerId;
        allow write: if false; // Only written by backend functions
    }

    // Audit Logs (Global collection)
    match /auditLogs/{logId} {
        // Partner users can read audit logs for their own partnerId
        allow read: if request.auth.token.partnerId == resource.data.partnerId;
        // Core CPay admins can read all audit logs
        allow read: if request.auth.token.role == 'ADMIN';
        allow write: if false; // Only written by backend functions
    }

    // Admin Audit Logs
    match /adminAuditLogs/{logId} {
        // Only admins can read admin audit logs
        allow read: if request.auth.token.role == 'ADMIN';
        allow write: if false; // Only written by backend functions
    }

    // ML Collections
    match /mlModels/{modelId} {
        allow read: if request.auth.token.role == 'ADMIN';
        allow write: if false; // Only written by backend functions
    }

    match /mlAnalytics/{analyticsId} {
        allow read: if request.auth.token.role == 'ADMIN';
        allow write: if false; // Only written by backend functions
    }

    match /trainingData/{dataId} {
        allow read: if request.auth.token.role == 'ADMIN';
        allow write: if false; // Only written by backend functions
    }

  }
}
