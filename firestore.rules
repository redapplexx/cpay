// firestore.rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is a member of a specific partner
    function isPartnerMember(partnerId) {
      return request.auth != null && request.auth.token.partnerId == partnerId;
    }

    // Helper function to check if a user has a specific role in a partner
    function hasPartnerRole(partnerId, role) {
      return isPartnerMember(partnerId) && request.auth.token.role == role;
    }
    
    function hasPartnerRoles(partnerId, roles) {
      return isPartnerMember(partnerId) && request.auth.token.role in roles;
    }

    // --- Partner Portal Rules ---
    match /partners/{partnerId} {
      // Any authenticated member of the partner can read the main partner document.
      allow read: if isPartnerMember(partnerId);
      
      // Only an 'OWNER' or 'ADMIN' of that partner can update settings.
      allow update: if hasPartnerRoles(partnerId, ['OWNER', 'ADMIN']);
      
      // Partner documents are created by a CPay super-admin, not by partners themselves.
      allow create: if false; 
    }
    
    match /partners/{partnerId}/users/{userId} {
      // Any member of the partner can see the list of users.
      allow list, read: if isPartnerMember(partnerId);
      
      // Only 'OWNER' or 'ADMIN' can add, update, or remove users from their team.
      allow write: if hasPartnerRoles(partnerId, ['OWNER', 'ADMIN']);
    }

    match /partners/{partnerId}/payoutBatches/{batchId} {
        // 'OPERATOR', 'ADMIN', 'OWNER' can create/read payout batches. 'VIEWER' can only read.
        allow create: if hasPartnerRoles(partnerId, ['OPERATOR', 'ADMIN', 'OWNER']);
        allow read: if isPartnerMember(partnerId);
        
        // Batches are immutable from the client once created.
        allow update, delete: if false;
    }
    
    match /partners/{partnerId}/payoutLogs/{logId} {
        // Any member of the partner can read the payout logs for their batches.
        allow read: if isPartnerMember(partnerId);
        
        // Logs are written by backend functions only.
        allow write: if false;
    }

    match /partners/{partnerId}/webhookLogs/{logId} {
        // 'ADMIN' or 'OWNER' can view and resend webhooks.
        allow read, update: if hasPartnerRoles(partnerId, ['ADMIN', 'OWNER']);
        allow create, delete: if false;
    }
    
    match /partners/{partnerId}/auditLogs/{logId} {
        // 'ADMIN' or 'OWNER' can view the audit trail for their partner account.
        allow read: if hasPartnerRoles(partnerId, ['ADMIN', 'OWNER']);
        allow write: if false;
    }
    
    // --- Existing CPay Rules (ensure they are separate and still apply) ---
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create: if false;
    }
    
    match /transactions/{transactionId} {
      allow read: if request.auth.uid == resource.data.sender.uid || request.auth.uid == resource.data.receiver.uid;
      allow write: if false;
    }
  }
}
